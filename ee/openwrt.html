<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenWrt 基础 | suda-morris 个人博客</title>
    <meta name="description" content="记录学习生活，探索未知领域">
    <link rel="icon" href="/blog/favicon.png">
  <link rel="manifest" href="/blog/manifest.json">
    
    <link rel="preload" href="/blog/assets/css/0.styles.c4b83633.css" as="style"><link rel="preload" href="/blog/assets/js/app.6e1e7fac.js" as="script"><link rel="preload" href="/blog/assets/js/2.5203ae48.js" as="script"><link rel="preload" href="/blog/assets/js/15.f9f7326e.js" as="script"><link rel="preload" href="/blog/assets/js/4.fa8a62ca.js" as="script"><link rel="preload" href="/blog/assets/js/3.ee9c868d.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.762f9583.js"><link rel="prefetch" href="/blog/assets/js/11.2fcfe9d0.js"><link rel="prefetch" href="/blog/assets/js/12.cfdaaa7e.js"><link rel="prefetch" href="/blog/assets/js/13.1cec2db5.js"><link rel="prefetch" href="/blog/assets/js/14.32ece556.js"><link rel="prefetch" href="/blog/assets/js/16.4e0e8e29.js"><link rel="prefetch" href="/blog/assets/js/17.ec71529e.js"><link rel="prefetch" href="/blog/assets/js/18.c216624d.js"><link rel="prefetch" href="/blog/assets/js/19.6fb51ee5.js"><link rel="prefetch" href="/blog/assets/js/20.8611442e.js"><link rel="prefetch" href="/blog/assets/js/21.f40529be.js"><link rel="prefetch" href="/blog/assets/js/22.db270325.js"><link rel="prefetch" href="/blog/assets/js/23.7548c7cb.js"><link rel="prefetch" href="/blog/assets/js/24.7c888ef3.js"><link rel="prefetch" href="/blog/assets/js/25.40664069.js"><link rel="prefetch" href="/blog/assets/js/26.99516395.js"><link rel="prefetch" href="/blog/assets/js/27.59199a94.js"><link rel="prefetch" href="/blog/assets/js/28.0a9e89ff.js"><link rel="prefetch" href="/blog/assets/js/29.2811c366.js"><link rel="prefetch" href="/blog/assets/js/30.93cdf7cb.js"><link rel="prefetch" href="/blog/assets/js/31.e44ba6cd.js"><link rel="prefetch" href="/blog/assets/js/32.1245768e.js"><link rel="prefetch" href="/blog/assets/js/33.11ea0b4a.js"><link rel="prefetch" href="/blog/assets/js/34.a6f68732.js"><link rel="prefetch" href="/blog/assets/js/35.86e7f52a.js"><link rel="prefetch" href="/blog/assets/js/36.af0c1d06.js"><link rel="prefetch" href="/blog/assets/js/37.c5bdf2bb.js"><link rel="prefetch" href="/blog/assets/js/38.5c01d9f7.js"><link rel="prefetch" href="/blog/assets/js/39.22ec9dd7.js"><link rel="prefetch" href="/blog/assets/js/40.a91fff8d.js"><link rel="prefetch" href="/blog/assets/js/41.6586df66.js"><link rel="prefetch" href="/blog/assets/js/42.0e31b534.js"><link rel="prefetch" href="/blog/assets/js/43.1d6da04e.js"><link rel="prefetch" href="/blog/assets/js/44.f7ea51d9.js"><link rel="prefetch" href="/blog/assets/js/45.83355131.js"><link rel="prefetch" href="/blog/assets/js/46.926e02d7.js"><link rel="prefetch" href="/blog/assets/js/47.d2bdfdf9.js"><link rel="prefetch" href="/blog/assets/js/48.86bbd8f6.js"><link rel="prefetch" href="/blog/assets/js/49.d8bfb0bf.js"><link rel="prefetch" href="/blog/assets/js/5.4ad359d4.js"><link rel="prefetch" href="/blog/assets/js/50.0ad0abd1.js"><link rel="prefetch" href="/blog/assets/js/51.a007cf9f.js"><link rel="prefetch" href="/blog/assets/js/52.ed15c1be.js"><link rel="prefetch" href="/blog/assets/js/53.d71408da.js"><link rel="prefetch" href="/blog/assets/js/54.1e98536a.js"><link rel="prefetch" href="/blog/assets/js/55.a84bedfe.js"><link rel="prefetch" href="/blog/assets/js/56.39b89665.js"><link rel="prefetch" href="/blog/assets/js/57.83bbc676.js"><link rel="prefetch" href="/blog/assets/js/58.05828456.js"><link rel="prefetch" href="/blog/assets/js/59.8fe98ad4.js"><link rel="prefetch" href="/blog/assets/js/6.5080ff4e.js"><link rel="prefetch" href="/blog/assets/js/60.fa16504e.js"><link rel="prefetch" href="/blog/assets/js/61.56eed8d6.js"><link rel="prefetch" href="/blog/assets/js/62.eda7f5c3.js"><link rel="prefetch" href="/blog/assets/js/63.da59083d.js"><link rel="prefetch" href="/blog/assets/js/64.f9b837f0.js"><link rel="prefetch" href="/blog/assets/js/65.2ca4c9dd.js"><link rel="prefetch" href="/blog/assets/js/66.b3f5c11f.js"><link rel="prefetch" href="/blog/assets/js/67.fc0db5ab.js"><link rel="prefetch" href="/blog/assets/js/68.105278b0.js"><link rel="prefetch" href="/blog/assets/js/69.d72640ac.js"><link rel="prefetch" href="/blog/assets/js/7.f49c4cfa.js"><link rel="prefetch" href="/blog/assets/js/70.f49ced8f.js"><link rel="prefetch" href="/blog/assets/js/71.17853e0b.js"><link rel="prefetch" href="/blog/assets/js/72.41a81933.js"><link rel="prefetch" href="/blog/assets/js/73.50147b93.js"><link rel="prefetch" href="/blog/assets/js/8.6e32f0dc.js"><link rel="prefetch" href="/blog/assets/js/9.67fbd9f3.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c4b83633.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link router-link-active">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">Others</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link router-link-active">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link">Others</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/ee/about.html" class="sidebar-link">关于本栏目</a></li><li><a href="/blog/ee/openwrt.html" class="active sidebar-link">OpenWrt 基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/ee/openwrt.html#flash分区" class="sidebar-link">Flash分区</a></li><li class="sidebar-sub-header"><a href="/blog/ee/openwrt.html#文件系统" class="sidebar-link">文件系统</a></li></ul></li></ul> </aside> <main class="page"> <div class="content default"><h1 id="openwrt-基础"><a href="#openwrt-基础" aria-hidden="true" class="header-anchor">#</a> OpenWrt 基础 <span class="badge warn" style="vertical-align:top;" data-v-c13ee5b0>整理中</span></h1> <h2 id="flash分区"><a href="#flash分区" aria-hidden="true" class="header-anchor">#</a> Flash分区</h2> <p>Linux系统对闪存类存储器是采用MTD设备驱动实现的。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>    0.290000<span class="token punctuation">]</span> spi-mt7621 10000b00.spi: sys_freq: 193333333
<span class="token punctuation">[</span>    0.300000<span class="token punctuation">]</span> m25p80 spi32766.0: w25q256 <span class="token punctuation">(</span>32768 Kbytes<span class="token punctuation">)</span>
<span class="token punctuation">[</span>    0.300000<span class="token punctuation">]</span> m25p80 spi32766.0: using chunked io
<span class="token punctuation">[</span>    0.310000<span class="token punctuation">]</span> 4 ofpart partitions found on MTD device spi32766.0
<span class="token punctuation">[</span>    0.310000<span class="token punctuation">]</span> Creating 4 MTD partitions on <span class="token string">&quot;spi32766.0&quot;</span><span class="token keyword">:</span>
<span class="token punctuation">[</span>    0.320000<span class="token punctuation">]</span> 0x000000000000-0x000000030000 <span class="token keyword">:</span> <span class="token string">&quot;u-boot&quot;</span>
<span class="token punctuation">[</span>    0.320000<span class="token punctuation">]</span> 0x000000030000-0x000000040000 <span class="token keyword">:</span> <span class="token string">&quot;u-boot-env&quot;</span>
<span class="token punctuation">[</span>    0.330000<span class="token punctuation">]</span> 0x000000040000-0x000000050000 <span class="token keyword">:</span> <span class="token string">&quot;factory&quot;</span>
<span class="token punctuation">[</span>    0.340000<span class="token punctuation">]</span> 0x000000050000-0x000002000000 <span class="token keyword">:</span> <span class="token string">&quot;firmware&quot;</span>
<span class="token punctuation">[</span>    0.410000<span class="token punctuation">]</span> 2 uimage-fw partitions found on MTD device firmware
<span class="token punctuation">[</span>    0.410000<span class="token punctuation">]</span> 0x000000050000-0x000000168da1 <span class="token keyword">:</span> <span class="token string">&quot;kernel&quot;</span>
<span class="token punctuation">[</span>    0.420000<span class="token punctuation">]</span> 0x000000168da1-0x000002000000 <span class="token keyword">:</span> <span class="token string">&quot;rootfs&quot;</span>
<span class="token punctuation">[</span>    0.420000<span class="token punctuation">]</span> mtd: device 5 <span class="token punctuation">(</span>rootfs<span class="token punctuation">)</span> <span class="token keyword">set</span> to be root filesystem
<span class="token punctuation">[</span>    0.430000<span class="token punctuation">]</span> 1 squashfs-split partitions found on MTD device rootfs
<span class="token punctuation">[</span>    0.440000<span class="token punctuation">]</span> 0x000000620000-0x000002000000 <span class="token keyword">:</span> <span class="token string">&quot;rootfs_data&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="tip custom-block"><p>系统在SPI设备上创建了4个MTD分区</p></div> <table><thead><tr><th>分区名</th> <th>分区作用</th></tr></thead> <tbody><tr><td>u-boot</td> <td>引导程序</td></tr> <tr><td>u-boot-env</td> <td>引导程序的配置数据</td></tr> <tr><td>factory</td> <td>路由器芯片的初始化参数</td></tr> <tr><td>firmware</td> <td>固件分区</td></tr> <tr><td>kernel</td> <td>固件分区<br>Linux 内核</td></tr> <tr><td>rootfs</td> <td>固件分区<br>文件系统子集</td></tr> <tr><td>rootfs_rom</td> <td>固件分区<br>文件系统子集<br>只读分区子集</td></tr> <tr><td>rootfs_data</td> <td>固件分区<br>文件系统子集<br>可写分区子集</td></tr></tbody></table> <div class="tip custom-block"><p>分区存在子分区，kernel和rootfs就是firmware的子分区，rootfs_rom和rootfs_data就是rootfs的子分区。</p></div> <h3 id="查看系统mtd分配"><a href="#查看系统mtd分配" aria-hidden="true" class="header-anchor">#</a> 查看系统MTD分配</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@Widora:~<span class="token comment"># cat /proc/mtd</span>
dev:    size   erasesize  name
mtd0: 00030000 00010000 <span class="token string">&quot;u-boot&quot;</span>
mtd1: 00010000 00010000 <span class="token string">&quot;u-boot-env&quot;</span>
mtd2: 00010000 00010000 <span class="token string">&quot;factory&quot;</span>
mtd3: 01fb0000 00010000 <span class="token string">&quot;firmware&quot;</span>
mtd4: 00118da1 00010000 <span class="token string">&quot;kernel&quot;</span>
mtd5: 01e9725f 00010000 <span class="token string">&quot;rootfs&quot;</span>
mtd6: 019e0000 00010000 <span class="token string">&quot;rootfs_data&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="查看系统mtd分配-2"><a href="#查看系统mtd分配-2" aria-hidden="true" class="header-anchor">#</a> 查看系统MTD分配</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@Widora:~<span class="token comment"># cat /proc/partitions </span>
major   minor  <span class="token comment">#blocks    name</span>
31       0        192   mtdblock0
31       1         64   mtdblock1
31       2         64   mtdblock2
31       3      32448   mtdblock3
31       4       1123   mtdblock4
31       5      31324   mtdblock5
31       6      26496   mtdblock6
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="读取-备份factory分区"><a href="#读取-备份factory分区" aria-hidden="true" class="header-anchor">#</a> 读取/备份factory分区</h3> <p>factory 分区（位于 /dev/mtd2）保存了重要的配置参数（如MAC地址，天线匹配参数等）。</p> <h4 id="查看分区内容"><a href="#查看分区内容" aria-hidden="true" class="header-anchor">#</a> 查看分区内容</h4> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@Widora:~<span class="token comment"># hexdump /dev/mtd2</span>
0000000 7628 0001 ef0c d2af b8a9 0000 0000 0000
0000010 ffff ffff ffff ffff ffff ffff ffff ffff
0000020 0000 0000 0020 0000 ef0c d2af b8a9 ef0c
0000030 d2af b9a9 3422 2000 ffff 0100 0000 0000
0000040 0000 0022 0000 0000 0030 0000 0000 0000
0000050 0081 9400 b040 c640 c31a c2c3 c5c0 0027
0000060 ffff ffff ffff ffff ffff ffff ffff ffff
*
00000a0 c6c6 c4c4 c0c4 c4c0 c4c4 c0c4 c0c0 0000
00000b0 ffff ffff ffff ffff ffff ffff ffff ffff
*
00000f0 0000 0000 00d1 8800 0000 0000 0000 0000
0000100 ffff ffff ffff ffff ffff ffff ffff ffff
*
0000120 0000 0000 0000 0000 0000 0000 0000 0077
0000130 1d11 1d11 7f15 7f15 7f17 7f17 3b10 3b10
0000140 ffff ffff ffff ffff ffff ffff ffff ffff
*
0010000
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><h4 id="备份分区"><a href="#备份分区" aria-hidden="true" class="header-anchor">#</a> 备份分区</h4> <p>使用 <code>dd</code> 命令将分区读到一个文件中，然后使用浏览器下载到本地。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@Widora:~<span class="token comment"># dd if=/dev/mtd2 of=/www/art.bin</span>
128+0 records <span class="token keyword">in</span>
128+0 records out
root@Widora:~<span class="token comment"># ls -l /www/art.bin</span>
-rw-r--r--    1 root     root         65536 Apr 27 18:26 /www/art.bin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="文件系统"><a href="#文件系统" aria-hidden="true" class="header-anchor">#</a> 文件系统</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>root@Widora:/<span class="token comment"># df</span>
Filesystem           1K-blocks      Used Available Use% Mounted on
rootfs                   26496       752     25744   3% /
/dev/root                 4864      4864         0 100% /rom
tmpfs                    63232        84     63148   0% /tmp
/dev/mtdblock6           26496       752     25744   3% /overlay
overlayfs:/overlay       26496       752     25744   3% /
tmpfs                      512         0       512   0% /dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>引导程序启动内核完成后，由内核加载 <code>rootfs_rom</code> 只读分区部分来完成系统的初步启动。<code>rootfs_rom</code> 只读分区采用的是 Linux 内核支持的 <strong>squashFS</strong> 文件系统，加载完毕后将其挂载到 <code>/rom</code> 目录，同时也挂载为 <code>/</code> 目录。</li> <li>系统将使用 <strong>JFFS2</strong> 文件系统格式化的 <code>rootfs_data</code> 可写文件分区并将这部分挂载到 <code>/overlay</code> 目录。</li> <li>系统再将 <code>/overlay</code> 透明挂载为 <code>/</code> 根目录。</li> <li>最后将一部分内存挂载为<code>/tmp</code> 目录。</li></ol></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/ee/openwrt.md" target="_blank" rel="noopener noreferrer">编辑此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">5/11/2019, 5:03:47 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/blog/ee/about.html" class="prev">
          关于本栏目
        </a></span> <!----></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.6e1e7fac.js" defer></script><script src="/blog/assets/js/2.5203ae48.js" defer></script><script src="/blog/assets/js/15.f9f7326e.js" defer></script><script src="/blog/assets/js/4.fa8a62ca.js" defer></script><script src="/blog/assets/js/3.ee9c868d.js" defer></script>
  </body>
</html>
