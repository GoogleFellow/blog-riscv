<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>suda-morris 个人博客</title>
    <meta name="description" content="记录学习生活，探索未知领域">
    <link rel="icon" href="/blog/favicon.png">
  <link rel="manifest" href="/blog/manifest.json">
    
    <link rel="preload" href="/blog/assets/css/0.styles.c4b83633.css" as="style"><link rel="preload" href="/blog/assets/js/app.929f4efc.js" as="script"><link rel="preload" href="/blog/assets/js/2.55766845.js" as="script"><link rel="preload" href="/blog/assets/js/46.cabc4cc5.js" as="script"><link rel="preload" href="/blog/assets/js/3.bdd9f9c8.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.efac9755.js"><link rel="prefetch" href="/blog/assets/js/11.573860ff.js"><link rel="prefetch" href="/blog/assets/js/12.015d593a.js"><link rel="prefetch" href="/blog/assets/js/13.e2b4b4fc.js"><link rel="prefetch" href="/blog/assets/js/14.1b12c03c.js"><link rel="prefetch" href="/blog/assets/js/15.f7bd023e.js"><link rel="prefetch" href="/blog/assets/js/16.1a13a71b.js"><link rel="prefetch" href="/blog/assets/js/17.152ecb75.js"><link rel="prefetch" href="/blog/assets/js/18.43c78ab3.js"><link rel="prefetch" href="/blog/assets/js/19.47431242.js"><link rel="prefetch" href="/blog/assets/js/20.220388fa.js"><link rel="prefetch" href="/blog/assets/js/21.874c93d0.js"><link rel="prefetch" href="/blog/assets/js/22.8a2e17a0.js"><link rel="prefetch" href="/blog/assets/js/23.3a38853b.js"><link rel="prefetch" href="/blog/assets/js/24.7b6171ce.js"><link rel="prefetch" href="/blog/assets/js/25.640454a0.js"><link rel="prefetch" href="/blog/assets/js/26.0347903f.js"><link rel="prefetch" href="/blog/assets/js/27.29e8f6cb.js"><link rel="prefetch" href="/blog/assets/js/28.ffd7aa3b.js"><link rel="prefetch" href="/blog/assets/js/29.119a039a.js"><link rel="prefetch" href="/blog/assets/js/30.88e34003.js"><link rel="prefetch" href="/blog/assets/js/31.72c2b4eb.js"><link rel="prefetch" href="/blog/assets/js/32.f757e439.js"><link rel="prefetch" href="/blog/assets/js/33.e2d47802.js"><link rel="prefetch" href="/blog/assets/js/34.e3583d86.js"><link rel="prefetch" href="/blog/assets/js/35.3e8035b3.js"><link rel="prefetch" href="/blog/assets/js/36.dd7189b0.js"><link rel="prefetch" href="/blog/assets/js/37.22fc291e.js"><link rel="prefetch" href="/blog/assets/js/38.9dae8763.js"><link rel="prefetch" href="/blog/assets/js/39.cd467148.js"><link rel="prefetch" href="/blog/assets/js/4.aefa4001.js"><link rel="prefetch" href="/blog/assets/js/40.6ec841f1.js"><link rel="prefetch" href="/blog/assets/js/41.66d6962e.js"><link rel="prefetch" href="/blog/assets/js/42.95ae3803.js"><link rel="prefetch" href="/blog/assets/js/43.15de53b9.js"><link rel="prefetch" href="/blog/assets/js/44.0726f9b0.js"><link rel="prefetch" href="/blog/assets/js/45.798596ba.js"><link rel="prefetch" href="/blog/assets/js/47.c1274e9a.js"><link rel="prefetch" href="/blog/assets/js/48.3024ecc6.js"><link rel="prefetch" href="/blog/assets/js/49.861a16ba.js"><link rel="prefetch" href="/blog/assets/js/5.ad0ca43c.js"><link rel="prefetch" href="/blog/assets/js/50.1ba3658b.js"><link rel="prefetch" href="/blog/assets/js/51.bde45d38.js"><link rel="prefetch" href="/blog/assets/js/52.437846eb.js"><link rel="prefetch" href="/blog/assets/js/53.e132e379.js"><link rel="prefetch" href="/blog/assets/js/54.7678a798.js"><link rel="prefetch" href="/blog/assets/js/55.8d3b29ab.js"><link rel="prefetch" href="/blog/assets/js/56.5095f5f0.js"><link rel="prefetch" href="/blog/assets/js/57.32612f8d.js"><link rel="prefetch" href="/blog/assets/js/58.0e797dfa.js"><link rel="prefetch" href="/blog/assets/js/59.051582b7.js"><link rel="prefetch" href="/blog/assets/js/6.df8090ce.js"><link rel="prefetch" href="/blog/assets/js/60.7bd1bd7b.js"><link rel="prefetch" href="/blog/assets/js/61.eb6863a7.js"><link rel="prefetch" href="/blog/assets/js/62.431190fe.js"><link rel="prefetch" href="/blog/assets/js/63.d04d6ba3.js"><link rel="prefetch" href="/blog/assets/js/64.dec0ba74.js"><link rel="prefetch" href="/blog/assets/js/65.6d54a20f.js"><link rel="prefetch" href="/blog/assets/js/66.e770164c.js"><link rel="prefetch" href="/blog/assets/js/67.78af2598.js"><link rel="prefetch" href="/blog/assets/js/68.42bdd3d8.js"><link rel="prefetch" href="/blog/assets/js/69.a4342b45.js"><link rel="prefetch" href="/blog/assets/js/7.1265e282.js"><link rel="prefetch" href="/blog/assets/js/70.13da06fa.js"><link rel="prefetch" href="/blog/assets/js/71.ffa7b1be.js"><link rel="prefetch" href="/blog/assets/js/72.658f36ab.js"><link rel="prefetch" href="/blog/assets/js/73.c4d92771.js"><link rel="prefetch" href="/blog/assets/js/74.80d3f73b.js"><link rel="prefetch" href="/blog/assets/js/8.3261deed.js"><link rel="prefetch" href="/blog/assets/js/9.9e76531c.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.c4b83633.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">suda-morris 个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">Others</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">Home</a></div><div class="nav-item"><a href="/blog/cs/" class="nav-link">CS</a></div><div class="nav-item"><a href="/blog/ee/" class="nav-link">EE</a></div><div class="nav-item"><a href="/blog/others/" class="nav-link router-link-active">Others</a></div> <a href="https://github.com/suda-morris/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/blog/others/about.html" class="sidebar-link">关于本栏目</a></li><li><a href="/blog/others/markdown.html" class="sidebar-link">Markdown 基本语法</a></li></ul> </aside> <main class="page"> <div class="content default"><p>title: LwIP Introduction---Based on ESP32
tags:</p> <ul><li>LwIP
categories:</li> <li>Geek Hobbies
author: suda-morris
date: 2018-07-30 13:20:23</li></ul> <hr> <h2 id="tcp-ip协议栈"><a href="#tcp-ip协议栈" aria-hidden="true" class="header-anchor">#</a> TCP/IP协议栈</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JwdJ.png" alt="TCP/IP协议栈"></p> <h2 id="lwip架构"><a href="#lwip架构" aria-hidden="true" class="header-anchor">#</a> LwIP架构</h2> <p><img src="https://s1.ax1x.com/2018/08/09/PyrZkR.png" alt="LwIP架构"></p> <h2 id="进程模型"><a href="#进程模型" aria-hidden="true" class="header-anchor">#</a> 进程模型</h2> <blockquote><p>进程模型是指TCP/IP协议栈的各协议入IP协议、TCP协议、ICMP协议等是如何实现的。</p></blockquote> <ul><li>TCP/IP协议栈的每个协议都通过一个不同的进程实现。在该模型下，每个进程都严格地与一个协议相对应。这种进程模型的优点是网络协议的每一层都很清晰，每一层都可以随时参与系统运行。该模型的缺点是进程间的上下文切换比较频繁，系统将为频繁的上下文切换付出较大的代价。</li> <li>TCP/IP协议栈驻留在操作系统的内核中，应用程序通过系统调用与TCP/IP协议栈通信。该模型下，各协议栈并非严格地与一个进程相对应。</li> <li>TCP/IP协议栈驻留在同一个进程中，独立于操作系统内核空间。LwIP采用正是这种方式，LwIP作为一个独立的进程，运行在用户空间内，其优点是可以方便地移植到不同的操作系统中运行。</li></ul> <h2 id="内存管理"><a href="#内存管理" aria-hidden="true" class="header-anchor">#</a> 内存管理</h2> <blockquote><p>LwIP的动态内存管理机制大致上可以分成三种：标准C运行库自带的内存分配策略、LwIP的动态内存堆分配策略、LwIP的动态内存池分配策略。</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/01/PwhSgK.png" alt="LwIP内存管理"></p> <ul><li>将MEM_LIBC_MALLOC设置为1，表明使用标准C库自带的内存分配策略</li> <li>将MEMP_MEM_MALLOC设置为1，表明使用LwIP自己的动态内存堆分配策略</li> <li>LwIP还支持内存池，不过在ESP-IDF中并没有被使能。相较于内存堆的动态分配，内存池效率更高，碎片少，但是会消耗更多的内存</li></ul> <h2 id="缓冲管理"><a href="#缓冲管理" aria-hidden="true" class="header-anchor">#</a> 缓冲管理</h2> <blockquote><p>LwIP的缓冲管理机制的功能是尽量避免内存拷贝，尽量较少对内存和空间的需求，提高程序的执行效率。LwIP使用数据结构pbuf来描述内存的缓冲数据包。</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/01/Pw4Mz6.png" alt="pbuf结构体"></p> <ul><li>由于实际发送或接收的数据包长度不一，而每个pbuf只能管理一部分数据，因此对于大容量的数据包，就必须使用多个pbuf才能完整地描述它</li> <li>type表明了该pbuf的类型，目前LwIP定义了四种类型的pbuf，分别是：<code>PBUF_RAM</code>，<code>PBUF_ROM</code>，<code>PBUF_REF</code>，<code>PBUF_POOL</code></li></ul> <p><img src="https://s1.ax1x.com/2018/08/01/Pw4RWq.png" alt="pbuf类型定义"></p> <ul><li>PBUF_RAM类型的pbuf是通过内存堆分配得到的，LwIP协议栈和应用程序要传递的数据一般都使用该类型的pbuf。</li> <li>PBUF_POOL类型的pbuf是通过内存池分配得到的，由于分配此类型的pbuf可以快速完成，适合中断处理，因此它更多地应用在网络设备驱动层。</li> <li>PBUF_REF和PBUF_ROM类型的pbuf基本相同，他们都是从内存池中申请分配pbuf结构首部空间，而不申请数据区的空间。两者的区别在于，前者指向RAM空间内的某段数据，后者指向ROM空间内的某段数据。</li></ul> <p><img src="https://s1.ax1x.com/2018/08/10/P63kMq.png" alt="pbuf结构"></p> <h3 id="pbuf管理api"><a href="#pbuf管理api" aria-hidden="true" class="header-anchor">#</a> pbuf管理API</h3> <blockquote><p>当使用Netconn API时，则使用netbuf（网络缓冲）发送/接收数据，netbuf只是pbuf结构的封装，它可容纳分配的或引用的数据。</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/10/P61IaD.png" alt="pbuf管理API"></p> <h2 id="网络接口层"><a href="#网络接口层" aria-hidden="true" class="header-anchor">#</a> 网络接口层</h2> <blockquote><p>在LwIP中，物理网络硬件的设备驱动通过网络接口结构体netif来描述一个硬件网络接口，并通过<code>netif_add</code>函数向全局变量netif链表结构增加一个硬件网络接口。</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/09/Pys12V.png" alt="网络接口"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** Generic data structure used for all lwIP network interfaces.
 *  The following fields should be filled in by the initialization
 *  function for the device driver: hwaddr_len, hwaddr[], mtu, flags */</span>
<span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token punctuation">{</span>
  <span class="token comment">/** pointer to next in linked list */</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
  <span class="token comment">/** IP address configuration in network byte order */</span>
  ip_addr_t ip_addr<span class="token punctuation">;</span>
  ip_addr_t netmask<span class="token punctuation">;</span>
  ip_addr_t gw<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6</span>
  <span class="token comment">/** Array of IPv6 addresses for this netif. */</span>
  ip_addr_t ip6_addr<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/** The state of each IPv6 address (Tentative, Preferred, etc).
   * @see ip6_addr.h */</span>
  u8_t ip6_addr_state<span class="token punctuation">[</span>LWIP_IPV6_NUM_ADDRESSES<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> ESP_LWIP</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ipv6_addr_cb<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">netif</span><span class="token operator">*</span> netif<span class="token punctuation">,</span> u8_t ip_idex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* callback for ipv6 addr states changed */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 */</span>
  <span class="token comment">/** This function is called by the network device driver
   *  to pass a packet up the TCP/IP stack. */</span>
  netif_input_fn input<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4</span>
  <span class="token comment">/** This function is called by the IP module when it wants
   *  to send a packet on the interface. This function typically
   *  first resolves the hardware address, then sends the packet. */</span>
  netif_output_fn output<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 */</span>
  <span class="token comment">/** This function is called by the ARP module when it wants
   *  to send a packet on the interface. This function outputs
   *  the pbuf as-is on the link medium. */</span>
  netif_linkoutput_fn linkoutput<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6</span>
  <span class="token comment">/** This function is called by the IPv6 module when it wants
   *  to send a packet on the interface. This function typically
   *  first resolves the hardware address, then sends the packet. */</span>
  netif_output_ip6_fn output_ip6<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_STATUS_CALLBACK</span>
  <span class="token comment">/** This function is called when the netif state is set to up or down
   */</span>
  netif_status_callback_fn status_callback<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_STATUS_CALLBACK */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_LINK_CALLBACK</span>
  <span class="token comment">/** This function is called when the netif link is set to up or down
   */</span>
  netif_status_callback_fn link_callback<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_LINK_CALLBACK */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_REMOVE_CALLBACK</span>
  <span class="token comment">/** This function is called when the netif has been removed */</span>
  netif_status_callback_fn remove_callback<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_REMOVE_CALLBACK */</span>
  <span class="token comment">/** This field can be set by the device driver and could point
   *  to state information for the device. */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>state<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_DHCP</span>
  <span class="token comment">/** the DHCP client state information for this netif */</span>
  <span class="token keyword">struct</span> <span class="token class-name">dhcp</span> <span class="token operator">*</span>dhcp<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> ESP_LWIP</span>
  <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>dhcps_pcb<span class="token punctuation">;</span>	
  dhcp_event_fn dhcp_event<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span>  </span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_DHCP */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_AUTOIP</span>
  <span class="token comment">/** the AutoIP client state information for this netif */</span>
  <span class="token keyword">struct</span> <span class="token class-name">autoip</span> <span class="token operator">*</span>autoip<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_AUTOCONFIG</span>
  <span class="token comment">/** is this netif enabled for IPv6 autoconfiguration */</span>
  u8_t ip6_autoconfig_enabled<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_AUTOCONFIG */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_SEND_ROUTER_SOLICIT</span>
  <span class="token comment">/** Number of Router Solicitation messages that remain to be sent. */</span>
  u8_t rs_count<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_SEND_ROUTER_SOLICIT */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6_DHCP6</span>
  <span class="token comment">/** the DHCPv6 client state information for this netif */</span>
  <span class="token keyword">struct</span> <span class="token class-name">dhcp6</span> <span class="token operator">*</span>dhcp6<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6_DHCP6 */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_HOSTNAME</span>
  <span class="token comment">/* the hostname for this netif, NULL is a valid value */</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>  hostname<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_HOSTNAME */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_CHECKSUM_CTRL_PER_NETIF</span>
  u16_t chksum_flags<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_CHECKSUM_CTRL_PER_NETIF*/</span>

  <span class="token comment">/** maximum transfer unit (in bytes) */</span>
  u16_t mtu<span class="token punctuation">;</span>
  <span class="token comment">/** number of bytes used in hwaddr */</span>
  u8_t hwaddr_len<span class="token punctuation">;</span>
  <span class="token comment">/** link level hardware address of this interface */</span>
  u8_t hwaddr<span class="token punctuation">[</span>NETIF_MAX_HWADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/** flags (see NETIF_FLAG_ above) */</span>
  u8_t flags<span class="token punctuation">;</span>
  <span class="token comment">/** descriptive abbreviation */</span>
  <span class="token keyword">char</span> name<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">/** number of this interface */</span>
  u8_t num<span class="token punctuation">;</span>
  
<span class="token macro property">#<span class="token directive keyword">if</span> MIB2_STATS</span>
  <span class="token comment">/** link type (from &quot;snmp_ifType&quot; enum from snmp_mib2.h) */</span>
  u8_t link_type<span class="token punctuation">;</span>
  <span class="token comment">/** (estimate) link speed */</span>
  u32_t link_speed<span class="token punctuation">;</span>
  <span class="token comment">/** timestamp at last change made (up/down) */</span>
  u32_t ts<span class="token punctuation">;</span>
  <span class="token comment">/** counters */</span>
  <span class="token keyword">struct</span> <span class="token class-name">stats_mib2_netif_ctrs</span> mib2_counters<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* MIB2_STATS */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV4 &amp;&amp; LWIP_IGMP</span>
  <span class="token comment">/** This function could be called to add or delete an entry in the multicast
      filter table of the ethernet MAC.*/</span>
  netif_igmp_mac_filter_fn igmp_mac_filter<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV4 &amp;&amp; LWIP_IGMP */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD</span>
  <span class="token comment">/** This function could be called to add or delete an entry in the IPv6 multicast
      filter table of the ethernet MAC. */</span>
  netif_mld_mac_filter_fn mld_mac_filter<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_IPV6 &amp;&amp; LWIP_IPV6_MLD */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_NETIF_HWADDRHINT</span>
  u8_t <span class="token operator">*</span>addr_hint<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_NETIF_HWADDRHINT */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> ENABLE_LOOPBACK</span>
  <span class="token comment">/* List of packets to be queued for ourselves. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_first<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>loop_last<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_LOOPBACK_MAX_PBUFS</span>
  u16_t loop_cnt_current<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_LOOPBACK_MAX_PBUFS */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* ENABLE_LOOPBACK */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> ESP_LWIP</span>
  <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>l2_buffer_free_notify<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>user_buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* Allows LWIP to notify driver when a L2-supplied pbuf can be freed */</span>
  ip_addr_t last_ip_addr<span class="token punctuation">;</span> <span class="token comment">/* Store last non-zero ip address */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br></div></div><ul><li><img src="https://s1.ax1x.com/2018/08/09/PysfPI.png" alt="IP信息"></li> <li>ip_addr，netmask，gw分别表示了IP地址、子网掩码、网关，建议这样子设定：<code>IP4_ADDR(&amp;ipaddr,192,168,1,100)</code></li> <li><img src="https://s1.ax1x.com/2018/08/09/Pysqaj.png" alt="硬件信息"></li> <li>mtu表明最大的网络传输个数，以字节为单位</li> <li>hwaddr存放了硬件接口的地址，对于以太网而言，就是MAC地址</li> <li>flags是硬件接口状态信息标志位，如是否建立连接状态，是否允许广播功能等</li> <li>name用来表示硬件接口使用的驱动类型，缩写，2个字节，比如蓝牙设备为“bl&quot;，wifi设备为&quot;wl&quot;</li> <li>num用来表示硬件接口的编号，当两个硬件接口的name字段相同时，该字段可以用来区分是哪一个硬件接口</li> <li><img src="https://s1.ax1x.com/2018/08/09/PysXin.png" alt="驱动功能"></li> <li>input是一个函数指针，它指向的函数用于将网络硬件接口接收到的数据包传递给上层TCP/IP协议栈</li> <li>output是一个函数指针，它所指向的函数用于将IP层的数据包发送到网络硬件接口上</li> <li>linkoutput是一个函数指针，在ARP模块中调用，output指向的函数也是通过调用linkoutput指向的函数实现数据报发送的</li></ul> <h2 id="arp处理"><a href="#arp处理" aria-hidden="true" class="header-anchor">#</a> ARP处理</h2> <blockquote><p>ARP协议是TCP/IP协议的基础，本质是实现IP地址与底层物理地址的相互转换。ARP协议的核心是ARP缓存表，而ARP协议的实质就是对缓存表的建立、更新、查询等操作。ARP缓存表是由若干缓存表项组成，在LwIP中，描述缓存表项的数据结构叫etharp_entry。</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/02/P0CQUA.png" alt="ARP协议数据包格式"></p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">etharp_entry</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> ARP_QUEUEING</span>
  <span class="token comment">/** Pointer to queue of pending outgoing packets on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">etharp_q_entry</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span> </span><span class="token comment">/* ARP_QUEUEING */</span>
  <span class="token comment">/** Pointer to a single pending outgoing packet on this ARP entry. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* ARP_QUEUEING */</span>
  ip4_addr_t ipaddr<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">netif</span> <span class="token operator">*</span>netif<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">eth_addr</span> ethaddr<span class="token punctuation">;</span>
  u16_t ctime<span class="token punctuation">;</span>
  u8_t state<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ul><li>ipaddr存放IP地址，ethaddr存放物理地址，state表示缓存项的状态（例如是否为空，是否稳定），ctime记录ARP缓存项处于某个状态的时间，当某表项的ctime值大于规定的表项最大生存值时，LwIP内核会删除该表项。因此使用ARP功能时，必须设置一个ARP超时事件，该超时事件的基本功能就是对每个表项的ctime字段值加1，然后删除那些生存时间大于最大生存值的表项</li></ul> <p><img src="https://s1.ax1x.com/2018/08/02/P0PcWt.jpg" alt="ARP处理流程"></p> <ul><li>函数ethernet_input根据报文首部的帧类型字段判断接收到的报文类型，如果是IP包，则将该包传递给etharp_ip_input，如果是ARP包，则将该包递交给etharp_arp_input</li> <li>函数etharp_ip_input调用函数update_arp_entry，它是将报文首部的MAC地址和IP地址更新到ARP缓存中</li> <li>函数etharp_arp_input首先判断接收到的ARP数据包的类型，如果是ARP请求包，那么首先判断这个包是否是给自己的，如果是给自己的，就在原有包的基础上重组一个ARP应答包发送出去；如果不是给自己的，则直接忽略而如果接收到的数据包是ARP应答包，那么就调用update_arp_entry更新ARP缓存表</li></ul> <h2 id="ip处理"><a href="#ip处理" aria-hidden="true" class="header-anchor">#</a> IP处理</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0CUbQ.png" alt="IP协议数据包格式"></p> <h4 id="lwip软件大致框架"><a href="#lwip软件大致框架" aria-hidden="true" class="header-anchor">#</a> LwIP软件大致框架</h4> <p><img src="https://s1.ax1x.com/2018/08/02/P0keJA.jpg" alt="LwIP整体框架图"></p> <ul><li>ip_input会做各项检查，包括协议版本号，IP首部的校验值，源IP地址是否有效等，然后检测IP数据包中的目的IP地址是否与本节点的IP地址相符，如果是本节点的IP地址，则根据该IP数据包首部的协议字段判断该数据包应该被递交到哪个上层协议，并调用相应的函数。如果是UDP协议，则调用udp_input函数；如果是TCP协议，则调用tcp_input函数；如果是ICMP协议，则调用icmp_input函数；如果是IGMP协议，则调用igmp_input函数；如果都不是，则调用函数icmp_dest_unreach返回一个协议不可达ICMP数据包给源主机。如果不是本节点的IP地址，则通过调用函数ip_forward对数据包进行转发。需要注意，由于一个节点可能含有多个IP地址，因此ip_input函数会遍历网络接口链表netif_list上的netif结构变量，来查找与IP数据包中相匹配的IP地址。</li> <li>ip_output使用ip_route函数查找目标网络接口netif来发送IP数据包。当网络接口netif确定后，IP数据包通过函数ip_output_if发送出去。若ip_route没有找到合适的网络接口，则丢弃该报文，终止本次发送。函数ip_route通过遍历网络接口链表netif_list，查找与目的IIP地址在同一个子网中的网络接口，并将该网络接口返回给变量netif。</li></ul> <h2 id="icmp处理"><a href="#icmp处理" aria-hidden="true" class="header-anchor">#</a> ICMP处理</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0AVmT.jpg" alt="ICMP协议数据包格式"></p> <ul><li>icmp_input在ip_input中被调用，它处理接收到的ICMP数据包，并根据包类型做相应的处理。在LwIP协议栈中，它只处理ICMP回显请求包，对其他类型的ICMP包不作响应。icmp_input在处理ICMP回显请求时，首先判断该数据包是否为广播或者组播包，如果是，则直接返回，不再继续处理；如果不是，则继续判断该数据包长度是否小于ICMP回显请求头部长度，如果是则丢弃数据包；如果不是则将该ICMP报文类型字段变为0，重新计算校验和，并将IP报文首部的源IP地址和目的IP地址交换位置，并通过调用函数ip_output_if将数据包发送出去。</li> <li>函数icmp_dest_unreach在ip_input、udp_input中被调用，它的功能是通过调用函数icmp_send_response发送一个“目的不可到达”类型的icmp报文。在函数ip_input中，当所接收的IP报文协议字段不可识别时，icmp_dest_unreach就被调用。而在UDP处理器中，若不能找到与接收的报文相对应的端口号，则icmp_dest_unreach也将被调用。</li> <li>函数icmp_time_exceeded在ip_forward中被调用，它的功能是通过调用函数icmp_send_response发送一个“超时”类型的ICMP报文。在函数ip_forward中，当TTL减小为0时，调用该函数。</li></ul> <h2 id="udp处理"><a href="#udp处理" aria-hidden="true" class="header-anchor">#</a> UDP处理</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JfdH.png" alt="UDP协议数据包"></p> <ul><li>函数udp_input将检查报文的UDP校验，最终调用函数recv，将收到的报文传递给应用层程序</li> <li>当应用层程序要通过UDP协议向外发送IP报文时，将通过调用函数udp_send实现，函数udp_send通过调用IP层的函数ip_output_if实现报文的发送</li> <li>LwIP使用链表结构体udp_pcb来保存每一个UDP会话的状态</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token punctuation">{</span>
<span class="token comment">/* Common members of all PCB types */</span>
  IP_PCB<span class="token punctuation">;</span>

<span class="token comment">/* Protocol specific PCB members */</span>

  <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

  u8_t flags<span class="token punctuation">;</span>
  <span class="token comment">/** ports are in host byte order */</span>
  u16_t local_port<span class="token punctuation">,</span> remote_port<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_MULTICAST_TX_OPTIONS</span>
  <span class="token comment">/** outgoing network interface for multicast packets */</span>
  ip_addr_t multicast_ip<span class="token punctuation">;</span>
  <span class="token comment">/** TTL for outgoing multicast packets */</span>
  u8_t mcast_ttl<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_MULTICAST_TX_OPTIONS */</span>

<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_UDPLITE</span>
  <span class="token comment">/** used for UDP_LITE only */</span>
  u16_t chksum_len_rx<span class="token punctuation">,</span> chksum_len_tx<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_UDPLITE */</span>

  <span class="token comment">/** receive callback function */</span>
  udp_recv_fn recv<span class="token punctuation">;</span>
  <span class="token comment">/** user-supplied argument for the recv callback */</span>
  <span class="token keyword">void</span> <span class="token operator">*</span>recv_arg<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="tcp处理"><a href="#tcp处理" aria-hidden="true" class="header-anchor">#</a> TCP处理</h2> <p><img src="https://s1.ax1x.com/2018/08/02/P0JULF.png" alt="TCP协议数据包"></p> <ul><li>TCP的滑动窗口协议是用于实现流量控制的</li> <li>TCP的超时和重传机制提高了数据传输的可靠性</li> <li>拥塞控制是通过慢启动算法和拥塞避免算法来实现的</li> <li>LwIP中含有两个定时器函数：tcp_fasttmr和tcp_slowtmr，tcp_fasttmr每250ms调用一次，tcp_slowtmr每500ms调用一次。快速定时器主要做两个方面的事情：向上层递交上层一直未接收的数据，二是发送该连接上的延迟ACK请求数据段。慢速定时器参与了较多功能，如超时与重传、拥塞控制等。</li></ul> <h2 id="常用api接口"><a href="#常用api接口" aria-hidden="true" class="header-anchor">#</a> 常用API接口</h2> <blockquote><p>LwIP提供了3种应用程序接口：</p> <ol><li>直接调用协议栈各模块的函数，它是基于回调函数的API接口，也成为RAW API接口，回调函数直接被协议栈代码调用，因此应用程序代码和TCP/IP协议栈运行在同一个进程里，无需使用操作系统，两者之间这种良好的结合可以使得程序的执行效率更高，而且在运行中它占用更少的内存资源</li> <li>使用LwIP提供的专用API接口，也称为Sequential API接口，程序的执行过程基于open-read-write-close模型，需要操作系统的支持，另外需要在文件lwipopts.h中把宏定义<code>NO_SYS</code>定义为0。Sequential API被分成两部分实现，一部分驻留在应用程序进程中，另一部分在TCP/IP协议栈进程内实现。这两部分API之间采用由操作系统模拟层提供的进程间通信机制进行通信。在LwIP中，操作系统模拟层是LwIP协议栈的一部分，它存在的目的是方面LwIP的移植，它在底层操作系统和LwIP协议栈之间提供了一个接口，当用户移植LwIP到一个新的目标系统的时候，只需要修改这个接口内的函数即可。驻留在应用程序进程中的API接口与TCP/IP协议栈进程中的API之间通过共享内存传递数据，对该共享内存区的描述是采用netbuf结构体</li> <li>BSD Socket兼容的Socket函数接口，但是BSD套接字需要将发送的数据从应用程序复制到TCP/IP协议栈的内部缓冲区，将会消耗系统有限的资源</li></ol></blockquote> <h3 id="tcp-raw-api"><a href="#tcp-raw-api" aria-hidden="true" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6l7j0.png" alt="TCP RAW API"></p> <table><thead><tr><th>函数</th> <th>说明</th></tr></thead> <tbody><tr><td>struct tcp_pcb* tcp_new()</td> <td>新建tcp协议控制块</td></tr> <tr><td>ert_t tcp_bind(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port)</td> <td>绑定本地IP地址和端口号，如果ipaddr为IP_ADDR_ANY，则将连接绑定到所有的本地IP地址上</td></tr> <tr><td>struct tcp_pcb* tcp_listen(struct tcp_pcb* pcb)</td> <td>使指定的连接开始进入监听状态，如果监听成功，就返回一个新的连接控制块pcb</td></tr> <tr><td>void tcp_accepted(struct tcp_pcb* pcb)</td> <td>通知LwIP一个新来的连接已经被接收，这个函数通常在由tcp_accept指定的回调函数中被调用</td></tr> <tr><td>void tcp_accept(struct tcp_pcb* pcb,err_t (*accept)(void* arg,struct tcp_pcb* newpcb,err_t err))</td> <td>指定处于监听状态的连接，在成功建立连接后要调用的回调方法</td></tr> <tr><td>err_t tcp_connect(struct tcp_pcb* pcb,struct ip_addr* ipaddr,u16_t port,err_t (* connected)(void* arg,struct tcp_pcb* tpcb,err_t err))</td> <td>请求连接到执行的远程主机</td></tr> <tr><td>err_t tcp_write(struct tcp_pcb* pcb,void* dataptr,u16_t len,u8_t copy)</td> <td>发送TCP数据，将要发送的数据放入发送队列中，由协议栈内核发送，copy为0则不会为发送的数据分配新的内存空间</td></tr> <tr><td>void tcp_sent(struct tcp_pcb* pcb,err_t (*sent)(void* arg,struct tcp_pcb* tpcb,u16_t len))</td> <td>指定当远程主机成功接收数据后，应用程序调用的回调函数</td></tr> <tr><td>void tcp_recv(struct tcp_pcb* pcb,err_t (* recv)(void* arg,struct tcp_pcb* tpcb,struct pbuf* p,err_t err))</td> <td>指定接收数据时调用的回调函数</td></tr> <tr><td>void tcp_recved(struct tcp_pcb* pcb,u16_t len)</td> <td>用于获取接收到的数据的长度，必须在tcp_recv指定的回调函数中被调用</td></tr> <tr><td>err_t tcp_close(struct tcp_pcb* pcb)</td> <td>关闭一个指定的TCP连接，调用该函数后将会释放pcb控制块所占用的内存空间</td></tr> <tr><td>void tcp_abort(struct tcp_pcb* pcb)</td> <td>终止一个指定的连接，调用该函数后，pcb控制块所占用的内存空间将被释放</td></tr> <tr><td>void tcp_err(struct tcp_pcb* pcb,void (*err)(void* arg,err_t err))</td> <td>指定处理错误的回调函数</td></tr></tbody></table> <h3 id="tcp-raw-api-2"><a href="#tcp-raw-api-2" aria-hidden="true" class="header-anchor">#</a> TCP RAW API</h3> <p><img src="https://s1.ax1x.com/2018/08/10/P6lLHU.png" alt="UDP RAW API"></p> <h3 id="netconn-api"><a href="#netconn-api" aria-hidden="true" class="header-anchor">#</a> Netconn API</h3> <ul><li>数据结构netconn描述了应用程序要使用API函数机那里一个连接的各种属性，包括了连接的类型、最近的故障代码、回调函数等。</li></ul> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">/** A netconn descriptor */</span>
<span class="token keyword">struct</span> <span class="token class-name">netconn</span> <span class="token punctuation">{</span>
  <span class="token comment">/** type of the netconn (TCP, UDP or RAW) */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_type</span> type<span class="token punctuation">;</span>
  <span class="token comment">/** current state of the netconn */</span>
  <span class="token keyword">enum</span> <span class="token class-name">netconn_state</span> state<span class="token punctuation">;</span>
  <span class="token comment">/** the lwIP internal protocol control block */</span>
  <span class="token keyword">union</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">ip_pcb</span>  <span class="token operator">*</span>ip<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">tcp_pcb</span> <span class="token operator">*</span>tcp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">udp_pcb</span> <span class="token operator">*</span>udp<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">raw_pcb</span> <span class="token operator">*</span>raw<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> pcb<span class="token punctuation">;</span>
  <span class="token comment">/** the last error this netconn had */</span>
  err_t last_err<span class="token punctuation">;</span>
  
<span class="token macro property">#<span class="token directive keyword">if</span> !LWIP_NETCONN_SEM_PER_THREAD</span>
  <span class="token comment">/** sem that is used to synchronously execute functions in the core context */</span>
  sys_sem_t op_completed<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token comment">/** mbox where received packets are stored until they are fetched
      by the netconn application thread (can grow quite big) */</span>
  sys_mbox_t recvmbox<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_TCP</span>
  <span class="token comment">/** mbox where new connections are stored until processed
      by the application thread */</span>
  sys_mbox_t acceptmbox<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_TCP */</span>
  <span class="token comment">/** only used for socket layer */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SOCKET</span>
  <span class="token keyword">int</span> socket<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SOCKET */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_SNDTIMEO</span>
  <span class="token comment">/** timeout to wait for sending data (which means enqueueing data for sending
      in internal buffers) in milliseconds */</span>
  s32_t send_timeout<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_RCVTIMEO */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_RCVTIMEO</span>
  <span class="token comment">/** timeout in milliseconds to wait for new data to be received
      (or connections to arrive for listening netconns) */</span>
  <span class="token keyword">int</span> recv_timeout<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_RCVTIMEO */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_RCVBUF</span>
  <span class="token comment">/** maximum amount of bytes queued in recvmbox
      not used for TCP: adjust TCP_WND instead! */</span>
  <span class="token keyword">int</span> recv_bufsize<span class="token punctuation">;</span>
  <span class="token comment">/** number of bytes currently in recvmbox to be received,
      tested against recv_bufsize to limit bytes on recvmbox
      for UDP and RAW, used for FIONREAD */</span>
  <span class="token keyword">int</span> recv_avail<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_RCVBUF */</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_SO_LINGER</span>
   <span class="token comment">/** values &lt;0 mean linger is disabled, values &gt; 0 are seconds to linger */</span>
  s16_t linger<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_SO_LINGER */</span>
  <span class="token comment">/** flags holding more netconn-internal state, see NETCONN_FLAG_* defines */</span>
  u8_t flags<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> LWIP_TCP</span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores how much is already sent. */</span>
  size_t write_offset<span class="token punctuation">;</span>
  <span class="token comment">/** TCP: when data passed to netconn_write doesn't fit into the send buffer,
      this temporarily stores the message.
      Also used during connect and close. */</span>
  <span class="token keyword">struct</span> <span class="token class-name">api_msg_msg</span> <span class="token operator">*</span>current_msg<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* LWIP_TCP */</span>
  <span class="token comment">/** A callback function that is informed about events for this netconn */</span>
  netconn_callback callback<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p><img src="https://s1.ax1x.com/2018/08/10/P61AED.png" alt="Netconn API"></p> <table><thead><tr><th>函数</th> <th>说明</th></tr></thead> <tbody><tr><td>struct netconn* netconn_new_with_proto_and_callback(enum netconn_type t,u8_t proto,netconn_callback callback)</td> <td>建立一个新的netconn连接</td></tr> <tr><td>err_t netconn_delete(struct netconn* conn)</td> <td>删除netconn所指向的连接</td></tr> <tr><td>err_t netconn_getaddr(struct netconn* conn,struct ip_addr* addr,u16_t* port,u8_t local)</td> <td>获取conn连接的主机IP地址和端口号</td></tr> <tr><td>err_t netconn_bind(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>将一个IP地址及端口号与conn指向的而连接绑定</td></tr> <tr><td>err_t netconn_connect(struct netconn* conn,struct ip_addr* addr,u16_t port)</td> <td>将服务器端的IP地址和端口号与conn指向的连接绑定</td></tr> <tr><td>err_t netconn_disconnect(struct netconn* conn)</td> <td>断开conn指向的连接</td></tr> <tr><td>err_t netconn_listen_with_backlog(struct netconn* conn，u8_t backlog)</td> <td>将conn指向的连接设定为监听状态</td></tr> <tr><td>struct netconn* netconn_accept(struct netconn* conn)</td> <td>接收客户端的连接，该函数会阻塞在acceptmbox邮箱上</td></tr> <tr><td>struct netbuf* netconn_recv(struct netconn* conn)</td> <td>接收数据，接收到的数据被封装为netbuf结构</td></tr> <tr><td>err_t netconn_sendto(struct netconn* conn,struct netbuf* buf,struct ip_addr* addr,u16_t port)</td> <td>向一个指定的IP地址和端口号发送数据，这个函数只能用在conn类型为UDP或者RAW的连接中</td></tr> <tr><td>err_t netconn_write(struct netconn* conn,const void* dataptr,size_t size,u8_t apiflag)</td> <td>向相应的TCP连接上发送数据，这个函数只能用于发送TCP的报文</td></tr> <tr><td>err_t nnetconn_close(struct netconn* conn)</td> <td>关闭conn指向的连接</td></tr></tbody></table> <ul><li>netconn_new_with_proto_and_callback首先调用netconn_alloc函数分配并初始化一个netconn结构，接下来该函数会构建一个api_msg消息，该消息要求内核执行函数do_newconn，最后调用函数tcpip_apimsg来将消息包装成tcpip_msg结构并发送出去。tcpip_thread函数解析该消息并调用函数do_newconn，do_newconn根据参数的类型调用函数tcp_new创建一个TCP控制块</li> <li>tcpip_thread是处理TCP/IP的内核协议栈进程，它只接收tcpip_msg结构封装的消息，并根据消息的类型来判定该消息来自物理网卡或应用层程序。如果接收到网卡的IP报文，则将该报文递交给ip_input函数；如果是应用层程序发送的消息，则通过调用消息指定的内核处理函数来完成相应的功能</li></ul> <h3 id="socket-api"><a href="#socket-api" aria-hidden="true" class="header-anchor">#</a> Socket API</h3> <blockquote><p>LwIP提供了标准BSD套接字API，它也是有序API，在内存构建于Netconn API之上。所谓“有序”是指其执行模型基于典型的阻塞式打开-读-写-关闭机制。</p></blockquote> <p><img src="https://s1.ax1x.com/2018/08/10/P61V4H.png" alt="Socket API"></p> <h2 id="lwip移植"><a href="#lwip移植" aria-hidden="true" class="header-anchor">#</a> LwIP移植</h2> <blockquote><ol><li>以太网接口任务用于接收来自物理网卡的数据报文，同时将收到的报文通过FreeRTOS提供的邮箱传递给TCP/IP协议栈任务。以太网接口任务平时处于挂起状态，当硬件收到报文时，将产生接收报文中断，该终端以信号量的方式将以太网接口任务激活</li> <li>应用程序使用TCP/IP协议栈提供的Sequential API接口访问LwIP，同时这两个独立的任务需要使用FreeRTOS提供的邮箱机制实现彼此之间信息的交互。Sequential API接口函数在FreeRTOS操作系统运行环境下是“阻塞”函数，也就是说应用程序任务在调用Sequential API接口函数时，将会被阻塞，直到收到来自TCP/IP协议栈返回的消息应答</li> <li>基于LwIP的TCP/IP协议栈与应用程序运行在两个独立的任务中</li></ol></blockquote> <p><img src="https://s1.ax1x.com/2018/08/09/PyyVRx.jpg" alt="网卡驱动移植"></p> <ol><li>以太网接口文件ethernetif.c的移植，主要包含<code>ethernet_low_level_init</code>，<code>ethernet_low_level_output</code>，<code>ethernetif_input</code>，<code>ethernetif_init</code>这几个函数的功能
<ul><li><code>ethernetif_input</code>函数用于从底层物理网卡读取报文，并将该报文向上传递给LwIP协议栈函数ethernet_input进行处理</li> <li><code>ethernetif_init</code>函数指定了网络接口netif对应的主机名及网卡描述，并指定了该网卡的MAC地址，同事还指定了netif的发送数据报文函数</li></ul></li> <li>操作系统模拟层文件sys_arch.c的移植，总的来时操作系统模拟层主要完成了与信号量、消息邮箱机制、线程相关的功能
<ul><li>在sys_arch.h文件中对信号量、邮箱、线程对象进行重定义</li> <li>sys_mbox_new函数，使用FreeRTOS提供的消息队列机制创建一个空的消息队列</li> <li>sys_mbox_free函数，删除一个队列，当该队列中还有未被取出的消息时，该函数应当报错，并通知应用程序</li> <li>sys_mbox_post函数，将消息发送到消息队列中，该函数是一个阻塞函数，当消息被发送至队列后，该函数才会退出阻塞状态</li> <li>sys_mbox_trypost函数，用于尝试将某个消息发送至消息队列中，当消息被成功投递后，则返回成功，否则返回失败</li> <li>sys_arch_mbox_fetch函数，用于从消息队列中取出一条消息，该函数是一个阻塞函数，调用该函数的线程若未取到消息，则在形参timeout所指定的时间内，该线程被阻塞。当超过timeout所指定的时间后，该线程恢复至就绪状态。若timeout为0，则调用该函数的线程一直被阻塞，直到收到消息</li> <li>sys_arch_mbox_tryfetch函数尝试从消息队列中取出消息，它是一个非阻塞函数，当取到消息时，则返回成功，否则立即退出，返回队列空</li> <li>sys_sem_new函数创建一个信号量，并根据形参的值指定好当前信号量的状态</li> <li>sys_arch_sem_wait函数在形参timeout指定的时间被阻塞，若timeout为0，则调用该函数的线程将一直被阻塞，直到等待的信号量被释放。但该函数取到信号量时，它将返回取到的该信号量所占的时间</li> <li>sys_sem_signal函数用于释放一个信号量</li> <li>sys_sem_free函数用于删除一个信号量</li> <li>sys_thread_new函数用于创建一个新的线程</li> <li>sys_init函数是操作系统模拟层的初始化函数，主要对定时器管理数组进行了初始化</li> <li>sys_zrch_timeouts函数用于返回当前任务的定时器管理链表首地址</li> <li>sys_arch_protect函数和sys_arch_unprotect函数在访问临界区资源时成对使用</li></ul></li> <li>ethernet_input函数的实现在独立模式和RTOS模式时是不同的：
<ul><li>在独立应用中，此函数必须被插入到应用的主循环中，以便轮询任何收到的包</li> <li>在RTOS应用中，此函数为一个阻塞线程，只有当得到所等待的信号量时才处理接收到的数据包。当以太网外设收到数据并产生中断时，会在中断处理函数中释放此信号量</li></ul></li></ol> <h2 id="lwip配置"><a href="#lwip配置" aria-hidden="true" class="header-anchor">#</a> LwIP配置</h2> <blockquote><p>LwIP提供了名为lwipopts.h的文件，它允许用户充分配置栈及其所有模块。用户不需要定义所有LwIP选项：如果未定义某选项，则使用opt.h文件中定义的默认值</p></blockquote> <ul><li>内存配置</li></ul> <p><img src="https://s1.ax1x.com/2018/08/10/P6GG5D.png" alt="LwIP内存配置"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/suda-morris/blog/edit/master/docs/others/lwip.md" target="_blank" rel="noopener noreferrer">编辑此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">5/13/2019, 3:12:04 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/blog/assets/js/app.929f4efc.js" defer></script><script src="/blog/assets/js/2.55766845.js" defer></script><script src="/blog/assets/js/46.cabc4cc5.js" defer></script><script src="/blog/assets/js/3.bdd9f9c8.js" defer></script>
  </body>
</html>
